<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <title>Recipe: dead-simple preview environments with GitHub, Travis, and Heroku - Thibaud’s blog</title>

  <link rel="stylesheet" href="/css/screen.css">

  
  <meta name="description" content="Developers love to automate things. Shave yaks. Automation can save tremendous time, but automating complex processes can also be a big time sink. This is a ...">
  <meta name="author" content="Thibaud Colas"><link rel="canonical" href="https://thib.me/recipe-dead-simple-preview-environments-with-github-travis-heroku">
  <link href="/favicon.ico" rel="shortcut icon">
  <link href="/atom.xml" rel="alternate" title="Thibaud’s blog" type="application/atom+xml">

  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:url" content="https://thib.me/recipe-dead-simple-preview-environments-with-github-travis-heroku">
  <meta property="og:type" content="article">
  <meta property="og:site_name" content="Thibaud’s blog">
  <meta name="twitter:site" content="@thibaud_colas">
  <meta name="twitter:creator" content="@thibaud_colas">
  <meta property="og:title" content="Recipe: dead-simple preview environments with GitHub, Travis, and Heroku">
  <meta property="og:description" content="Developers love to automate things. Shave yaks. Automation can save tremendous time, but automating complex processes can also be a big time sink. This is a ...">
  
  <meta name="twitter:label1" value="Reading time">
  <meta name="twitter:data1" value="Not too long">

  <link rel="meta" title="FOAF" type="application/rdf+xml" href="/foaf.rdf">

  
  <script>
    window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
    ga('create','UA-34692999-4','auto');ga('send','pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>


</head>

<body   >
  <header><hgroup>
  <h1><a href="/">Thibaud’s blog</a></h1>
  
    <h2>Notes, thoughts, and open-source software</h2>
  
</hgroup>

</header>
  <nav>  
<ul class="main-navigation">
  <li><a href="https://twitter.com/thibaud_colas">Twitter</a></li>
  <li><a href="https://github.com/thibaudcolas">GitHub</a></li>
  <li><a href="/resume" data-no-instant>Resume</a></li>
  <li><a href="/about/">About</a></li>
</ul>

</nav>
  <div role="main" id="main">
    <div id="content">
      <div class="blog-index">
<article class="hentry">
  
  <header>
    
      <a class="edit-link" aria-label="Edit this page on GitHub" href="https://github.com/thibaudcolas/thibaudcolas/edit/main/src/_posts/2017-12-23-recipe-dead-simple-preview-environments-with-github-travis-heroku.md">Edit</a>
      <h1 class="entry-title">Recipe: dead-simple preview environments with GitHub, Travis, and Heroku</h1>
    
    
      <p class="meta">
        









<time datetime="2017-12-23T07:15:54+00:00" pubdate data-updated="true">2017-12-23 07:15</time>
        
      </p>
    
  </header>


<div class="entry-content" data-no-instant><p>Developers love to automate things. Shave yaks. Automation can save tremendous time, but automating complex processes can also be a big time sink. <em>This is a story in compromise</em>.</p>

<p>The other thing developers love is free software. I love GitHub, Travis, and Heroku because they all provide a very generous free usage tier – let’s have a look at how we can leverage them to automate preview environments (think: preview the result of a new pull request) for <a href="https://github.com/wagtail/wagtail">Wagtail</a>, a project I frequently contribute to.</p>

<p><strong>A disclaimer</strong> – the end result isn’t full automation, it still is a manual process. We shall call this <em>semi-automated</em> preview environments.</p>

<!-- more -->

<h2 id="goal">Goal</h2>

<p>We want to automate the deployment of <a href="https://github.com/wagtail/wagtail/pulls">Wagtail pull requests</a> to a preview environment that can be used to review the changes. For our purposes, we will use Wagtail’s official demo project: <a href="https://github.com/wagtail/bakerydemo">bakerydemo</a>, which has been tested extensively and contains demo content for most features.</p>

<p>The general workflow is:</p>

<ul>
  <li>A contributor makes a pull request.</li>
  <li>We decide to create a preview environment for it, and make a first deployment.</li>
  <li>The pull request is updated.</li>
  <li>The new version is deployed to the preview environment.</li>
</ul>

<p>Ideally this would all happen without any human interaction. Send a PR, a bot creates the environment and comments on the PR with a ready-made link. For now, all of these steps will be manual.</p>

<h2 id="prerequisites">Prerequisites</h2>

<blockquote>
  <p>This is a story in using other people’s software, and infrastructure. If you have sysadmin knowledge and-or want to control your infrastructure, you will be disappointed. I hear <a href="https://www.docker.com/">Docker</a> is good.</p>
</blockquote>

<p>The basic ingredients for our recipe are:</p>

<ul>
  <li>Accounts for <a href="https://github.com">GitHub</a>, <a href="https://travis-ci.org">Travis</a> (use your GitHub account), and <a href="https://www.heroku.com/">Heroku</a>.</li>
  <li>Command-line clients: <a href="https://github.com/travis-ci/travis.rb#command-line-client">Travis CLI</a>, <a href="https://devcenter.heroku.com/articles/heroku-cli">Heroku CLI</a>.</li>
  <li>A fork of Wagtail, and bakerydemo</li>
</ul>

<h2 id="creating-a-deployment-ready-preview-branch-for-wagtail">Creating a deployment-ready preview branch for Wagtail</h2>

<p>For Wagtail, the main thing we need to overcome is that static files need to be compiled before deployment in order for the CMS to work. Ideally, this would be done in Heroku whenever the app is deployed, but ~until I get this working~ for now we can simply create a separate branch and commit the static files to git. For this example, let’s say we are building a preview branch for <a href="https://github.com/wagtail/wagtail/pull/3942">PR #3942, Streamfield UI changes</a>, which is based off a branch named <code class="language-plaintext highlighter-rouge">2325-streamfield-ui</code>.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># From your Wagtail fork, open the branch you would like to deploy.</span>
git checkout <span class="nt">-b</span> 2325-streamfield-ui
<span class="c"># Create a branch for the static files. I like to prefix these with `dist/`:</span>
git checkout <span class="nt">-b</span> dist/2325-streamfield-ui
</code></pre></div></div>

<p>Then, remove static file ignores in git. Here is <a href="https://github.com/thibaudcolas/wagtail/commit/87b0d16e0d36899d47d60829b44decbc8cbebf65">a commit</a> you can cherry-pick to remove all static file ignores.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Then, rebuild the static files and commit them to Git.</span>
npm run dist
git add <span class="nb">.</span>
git commit <span class="nt">-m</span> <span class="s1">'Add static files to branch'</span>
git push <span class="nt">-u</span> origin dist/2325-streamfield-ui
</code></pre></div></div>

<h2 id="creating-a-new-preview-environment-for-bakerydemo">Creating a new preview environment for bakerydemo</h2>

<p>This should only be necessary once per pull request. Start by thinking for a name for the preview environment. For this example, we will use <code class="language-plaintext highlighter-rouge">bakerydemo-foo</code>.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># From your bakerydemo fork, create a new branch and a new Heroku app.</span>
git checkout <span class="nt">-b</span> bakerydemo-foo
heroku apps:create bakerydemo-foo
<span class="c"># Link the two via a git remote pointing to Heroku.</span>
heroku git:remote <span class="nt">--app</span> bakerydemo-foo <span class="nt">--remote</span> heroku-bakerydemo-foo

<span class="c"># Let's configure the environment for Django.</span>
heroku config:set <span class="nv">DJANGO_DEBUG</span><span class="o">=</span>off
heroku config:set <span class="nv">DJANGO_SETTINGS_MODULE</span><span class="o">=</span>bakerydemo.settings.production
heroku config:set <span class="nv">DJANGO_SECURE_SSL_REDIRECT</span><span class="o">=</span>on

<span class="c"># Finally, we can configure Travis so it automatically syncs the branches to Heroku.</span>
<span class="c"># This isn't strictly necessary, but it takes us a bit closer to the "no manual steps" ideal.</span>
travis setup heroku
travis <span class="nb">enable</span>
</code></pre></div></div>

<p>Here is the full Travis configuration:</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">sudo</span><span class="pi">:</span> <span class="no">false</span>
<span class="na">language</span><span class="pi">:</span> <span class="s">python</span>
<span class="na">branches</span><span class="pi">:</span>
  <span class="na">only</span><span class="pi">:</span>
    <span class="c1"># Only build the branches meant for the automated deployment.</span>
    <span class="pi">-</span> <span class="s">bakerydemo-foo</span>
<span class="na">install</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">echo 'There is no install step'</span>
<span class="na">script</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">echo 'Automated deployment to Heroku'</span>
<span class="na">deploy</span><span class="pi">:</span>
  <span class="na">provider</span><span class="pi">:</span> <span class="s">heroku</span>
  <span class="na">api_key</span><span class="pi">:</span>
    <span class="na">secure</span><span class="pi">:</span> <span class="s">hashed API key in base64</span>
  <span class="na">app</span><span class="pi">:</span>
    <span class="c1"># When there are multiple preview environments, map branch names to Heroku apps.</span>
    <span class="na">bakerydemo-foo</span><span class="pi">:</span> <span class="s">bakerydemo-foo</span>
<span class="na">notifications</span><span class="pi">:</span>
  <span class="na">email</span><span class="pi">:</span> <span class="no">false</span>
</code></pre></div></div>

<p>Important step – in the <code class="language-plaintext highlighter-rouge">requirements.txt</code> (or <code class="language-plaintext highlighter-rouge">base.txt</code>), install from the newly created branch based on the PR:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">Django</span><span class="o">==</span>1.11.5
django-dotenv<span class="o">==</span>1.4.1

<span class="c"># Note how we reference our dist/ preview branch of Wagtail, on our fork, from the last step.</span>
<span class="nt">-e</span> git+https://github.com/thibaudcolas/wagtail.git@dist/2325-streamfield-ui#egg<span class="o">=</span>wagtail

http://playground.torchboxapps.com/matthew/wagtail/wagtailfontawesome-1.1.1-py2.py3-none-any.whl
<span class="nv">Pillow</span><span class="o">==</span>4.0.0
</code></pre></div></div>

<p>Last step, sync up everything:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># If you've configured Travis to push to Heroku, this would be enough.</span>
git push <span class="nt">-u</span> origin bakerydemo-foo
<span class="c"># If you want to directly push to Heroku anyway.</span>
git push heroku-bakerydemo-foo bakerydemo-foo:master
</code></pre></div></div>

<p>That’s it! Your preview environment should be up and running at https://bakerydemo-foo.herokuapp.com/.</p>

<h2 id="updating-the-preview-environment">Updating the preview environment</h2>

<p>Changes were made on the PR. Now it’s time to deploy again. This is much more straightforward:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># From your Wagtail fork, open the branch you would like to re-deploy and get the latest changes.</span>
git checkout 2325-streamfield-ui
git pull
<span class="c"># Go to the static files branch and update it too.</span>
git checkout dist/2325-streamfield-ui
git reset <span class="nt">--hard</span> 2325-streamfield-ui
<span class="c"># Cherry-pick the commit ignoring the static files. Note: your commit hash will be different.</span>
git cherry-pick 5ec4c586a
<span class="c"># Rebuild the static files and commit them to Git.</span>
npm run dist
git add <span class="nb">.</span>
git commit <span class="nt">-m</span> <span class="s1">'Add static files to branch'</span>
git push <span class="nt">-uf</span> origin dist/2325-streamfield-ui
</code></pre></div></div>

<p>Now, all you need to do is redeploy the Heroku app. Just add a new empty commit on the <code class="language-plaintext highlighter-rouge">bakerydemo</code> branch:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git checkout bakerydemo-foo
git commit <span class="nt">--allow-empty</span> <span class="nt">-m</span> <span class="s1">'Deploy latest changes to bakerydemo-foo'</span>
<span class="c"># If you've configured Travis to push to Heroku, this would be enough.</span>
git push <span class="nt">-u</span> origin bakerydemo-foo
<span class="c"># If you want to directly push to Heroku anyway.</span>
git push heroku-bakerydemo-foo bakerydemo-foo:master
</code></pre></div></div>

<p>Wait for the builds to finish, and your preview environment will be ready again at https://bakerydemo-foo.herokuapp.com/. Don’t forget to clear your cache!</p>

<h2 id="improving-upon-this-workflow">Improving upon this workflow</h2>

<p>This could be faster, and less error-prone. I quite like the idea of being able to deploy arbitrary repositories (rather than only the one the PR is made from), but it shouldn’t be necessary to manually build the static files and commit them to a throw-away branch. Here are some potential improvements:</p>

<h3 id="build-static-files-directly-on-heroku">Build static files directly on Heroku</h3>

<p>Adding the Node buildpack on Heroku, and configuring the environment to install development dependencies, it should be possible to do the compilation on Heroku, and point the <code class="language-plaintext highlighter-rouge">bakerydemo</code> directly at the PR’s initial branch:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>heroku buildpacks:clear
heroku buildpacks:add heroku/nodejs
heroku buildpacks:add heroku/python

heroku config:set <span class="nv">NPM_CONFIG_PRODUCTION</span><span class="o">=</span><span class="nb">false
</span>heroku config:set <span class="nv">NODE_ENV</span><span class="o">=</span>development

<span class="c"># Then build the files in the postdeploy hook.</span>
</code></pre></div></div>

<h3 id="use-a-bot-to-do-the-manual-steps">Use a bot to do the manual steps</h3>

<p>A tool like <a href="http://danger.systems/js/">Danger</a> could have a bot automatically process pull requests in the main project’s build, and do all of the steps above automatically.</p>

<h3 id="leverage-higher-level-heroku-features">Leverage higher-level Heroku features</h3>

<ul>
  <li>Review apps https://devcenter.heroku.com/articles/github-integration-review-apps</li>
  <li>Pipelines https://devcenter.heroku.com/articles/pipelines</li>
</ul>

<h2 id="onwards">Onwards</h2>

<p>I hope this helps! In my experience, setting up a new preview environment takes about 15mins for someone familiar with Git / Travis / Heroku, and deploying changes is at most 5 minutes.</p>

<p>I may have a look at automating this further (in particular removing the need for static file branches) later on.</p>
</div>



  <footer>
    <p class="meta">
      
<span class="byline author vcard">By <span class="fn">Thibaud Colas</span></span>

      









<time datetime="2017-12-23T07:15:54+00:00" pubdate data-updated="true">2017-12-23 07:15</time>
      

<span class="categories">
  
    
      <a class="category" href="/categories/tools/">Tools</a>,
    
      <a class="category" href="/categories/wagtail/">Wagtail</a>,
    
      <a class="category" href="/categories/automation/">Automation</a>
    
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/python-memory-profiling-for-the-draft-js-exporter" title="Previous Post: Python memory profiling and speed benchmarks for the Draft.js exporter">&laquo; Python memory profiling and speed benchmarks for the Draft.js exporter</a>
      
      
        <a class="basic-alignment right" href="/why-wagtail-new-editor-is-built-with-draft-js" title="Next Post: Why Wagtail’s new editor is built with Draft.js">Why Wagtail’s new editor is built with Draft.js &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/nextjs-loves-wagtail">Next.js ❤️ Wagtail</a>
      </li>
    
      <li class="post">
        <a href="/wagtail-accessibility-statistics-for-gaad-2023">Wagtail accessibility statistics for GAAD 2023</a>
      </li>
    
      <li class="post">
        <a href="/estimating-wagtail-websites-emissions">Estimating Wagtail websites’ emissions</a>
      </li>
    
      <li class="post">
        <a href="/google-season-of-docs-creating-wagtail-developer-onboarding-tutorials">Google Season of Docs: Creating Wagtail Developer Onboarding Tutorials</a>
      </li>
    
      <li class="post">
        <a href="/evaluating-carbon-footprint-django-wagtail">Evaluating the carbon footprint of Django and Wagtail - Django London</a>
      </li>
    
  </ul>
</section>

  
<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos" data-user="thibaudcolas" data-count="5">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/thibaudcolas">@thibaudcolas</a> on GitHub
  
  <script src="/javascripts/github.js"></script>
</section>


</aside>


    </div>
  </div>
  <footer><p>
  By <a href="" rel="author">Thibaud Colas</a> -
  Content available under <a class="license" rel="license" href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a> -
  <span class="credit">Hosted on <a href="https://pages.github.com/">GitHub Pages</a></span> -
  <a class="fork-link" href="https://github.com/thibaudcolas/thibaudcolas">View source</a>
</p>

</footer>
  

<script src="/javascripts/libs/instantclick.min.js" data-no-instant></script>
<script data-no-instant>InstantClick.init(50);</script>


</body>
</html>
