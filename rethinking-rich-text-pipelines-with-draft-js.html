<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <title>Rethinking rich text pipelines with Draft.js - Thibaud’s blog</title>

  <link rel="stylesheet" href="/css/screen.css">

  
  <meta name="description" content="Discussing rich text capabilities in a CMS is an exercise in compromise. Authors want the flexibility to be creative in their content. Developers want to ens...">
  <meta name="author" content="Thibaud Colas"><link rel="canonical" href="https://www.draftail.org/blog/2018/03/13/rethinking-rich-text-pipelines-with-draft-js">
  <link href="/favicon.ico" rel="shortcut icon">
  <link href="/atom.xml" rel="alternate" title="Thibaud’s blog" type="application/atom+xml">

  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:url" content="https://www.draftail.org/blog/2018/03/13/rethinking-rich-text-pipelines-with-draft-js">
  <meta property="og:type" content="article">
  <meta property="og:site_name" content="Thibaud’s blog">
  <meta name="twitter:site" content="@thibaud_colas">
  <meta name="twitter:creator" content="@thibaud_colas">
  <meta property="og:title" content="Rethinking rich text pipelines with Draft.js">
  <meta property="og:description" content="Discussing rich text capabilities in a CMS is an exercise in compromise. Authors want the flexibility to be creative in their content. Developers want to ens...">
  
  <meta name="twitter:label1" value="Reading time">
  <meta name="twitter:data1" value="Not too long">

  <link rel="meta" title="FOAF" type="application/rdf+xml" href="/foaf.rdf">

  
  <script>
    window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
    ga('create','UA-34692999-4','auto');ga('send','pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>


</head>

<body   >
  <header><hgroup>
  <h1><a href="/">Thibaud’s blog</a></h1>
  
    <h2>Notes, thoughts, and open-source software</h2>
  
</hgroup>

</header>
  <nav>  
<ul class="main-navigation">
  <li><a href="https://twitter.com/thibaud_colas">Twitter</a></li>
  <li><a href="https://github.com/thibaudcolas">GitHub</a></li>
  <li><a href="/resume" data-no-instant>Resume</a></li>
  <li><a href="/about/">About</a></li>
</ul>

</nav>
  <div role="main" id="main">
    <div id="content">
      <div class="blog-index">
<article class="hentry">
  
  <header>
    
      <a class="edit-link" aria-label="Edit this page on GitHub" href="https://github.com/thibaudcolas/thibaudcolas/edit/main/src/_posts/2018-03-13-rethinking-rich-text-pipelines-with-draft-js.md">Edit</a>
      <h1 class="entry-title">Rethinking rich text pipelines with Draft.js</h1>
    
    
      <p class="meta">
        









<time datetime="2018-03-13T18:03:21+00:00" pubdate data-updated="true">2018-03-13 18:03</time>
        
      </p>
    
  </header>


<div class="entry-content" data-no-instant><p>Discussing rich text capabilities in a CMS is an exercise in compromise. Authors want the flexibility to be creative in their content. Developers want to ensure said content fits in the box. This can feel like fighting over the bed covers with a spouse: everyone initially means well, but things turn sour and we all wish for a bigger duvet. Or a more understanding spouse.</p>

<p>I believe the fundamental problem is one of control – for end users, control over content formatting, and predictability of the overall system. And for developers, control over content processing and rendering. Let’s crack open the rich text black box, and give everyone their fair share of the duvet.</p>

<!-- more -->

<h2 id="introducing-draftjs">Introducing Draft.js</h2>

<p>Rich text pipelines usually process HTML, or a subset of it. With Draft.js, we instead work with a different content model that has been designed for rich text, and doesn’t rely on browser-managed HTML. Here is what you need to know:</p>

<ul>
  <li><a href="https://draftjs.org/">Draft.js</a> is a framework for building rich text editors, powered by an immutable model.</li>
  <li>The content “source of truth” is separate from HTML rendered in the editor via <a href="https://developer.mozilla.org/en-US/docs/Web/Guide/HTML/Editable_content"><code class="language-plaintext highlighter-rouge">contenteditable</code></a> (which has highly unreliable behavior between browsers).</li>
  <li>It follows a fixed schema, with predefined formats (eg. bold) but also the opportunity to make custom ones.</li>
  <li>There are strong constraints on content structure – what is block-level formatting and what is inline, what can have data and how.</li>
</ul>

<p>If you want to know the full story, have a look at <a href="https://www.draftail.org/blog/2018/03/05/why-wagtail-new-editor-is-built-with-draft-js">Why Wagtail’s new editor is built with Draft.js</a>.</p>

<h2 id="the-rich-text-pipeline">The rich text pipeline</h2>

<p>With the presentations out of the way, let’s have a look at how Draft.js affects the overall rich text pipeline. Here is a representation of rich text processing from content entry to rendering on the site:</p>

<p><img src="/images/rich-text-lifecycle-v1.png" alt="Diagram of the rich text lifecycle, from user input to page rendering" /></p>

<p>In words,</p>

<ol>
  <li>The user types into the editor, or pastes from Word.</li>
  <li>Content goes through filtering and validation rules before arriving in the editor’s internal state.</li>
  <li>On save, the content makes its way server-side, and potentially goes through more filtering and validation before being saved in the database.</li>
  <li>When displaying content, it is fetched from the database and potentially goes through a hydration / rendering step.</li>
</ol>

<p>This isn’t a simple process. The fundamental problem is that rich text is generally unstructured, lacking in semantics beyond those of HTML. We don’t want to give users the freedom to use arbitrary HTML though, far from it. Let’s see how Draft.js helps.</p>

<h3 id="content-filtering-and-validation">Content filtering and validation</h3>

<p>First off, why are there two filtering / validation steps in the diagram above? It seems rather wasteful! Unless, that is, the editor couldn’t be trusted with its content validation, and a second step was required to whitelist all formatting. This is exactly what <a href="https://github.com/wagtail/wagtail">Wagtail</a> did before we switched to our Draft.js editor.</p>

<p>Here is a GIF illustrating the popular “paste from Word” workflow with Wagtail’s previous <code class="language-plaintext highlighter-rouge">contenteditable</code> editor:</p>

<p><img src="/images/hallo-paste-from-word.gif" alt="Screencast of Word copy-pasting into Wagtail’s previous editor. Some unwanted formatting makes its way into the saved content." /></p>

<p>Pasting rich text preserves <strong>a lot</strong> of unwanted or irrelevant styles, and there is no indication whatsoever that the content is problematic. Saving the content and reloading the page, we see the server-side filtering kick into action and – <em>surprise</em> – reveal Microsoft Word metadata and styles (wich is plain gibberish for a user). Even if that was properly removed, the rich text still contains unwanted formattings – subscript and superscript in this case.</p>

<p>By contrast, here is the Draft.js equivalent:</p>

<p><img src="/images/draftail-paste-from-word.gif" alt="Screencast of Word copy-pasting into Wagtail’s new editor. Content is correctly filtered on paste." /></p>

<p>No need to waste time reloading the page, all of the filtering happens on paste, in the browser. This is possible because:</p>

<ul>
  <li>The structured, fixed-schema content model is separate from contenteditable’s HTML. It is impossible to enter content that does not respect this schema.</li>
  <li>A formats whitelist filters out all of the content that respects the schema, but is not enabled in the editor.</li>
  <li>Draft.js comes with APIs to programmatically manipulate content, allowing further arbitrary processing.</li>
</ul>

<blockquote>
  <p>Have a look at the <a href="https://github.com/thibaudcolas/draftjs-filters">Draft.js filters</a> that power our editor to see how this works under the hood.</p>
</blockquote>

<hr />

<p>What about validation? For rich text, this usually means calculating some metrics on the content, like its length against a set maximum or minimum. This could be be hard if the content was HTML, and as a result developers often prefer to calculate string length including the HTML formatting, leading to a bad user experience.</p>

<p>There again, Draft.js having a fixed schema and an API makes this much simpler. Here is an example, calculating the plain-text length of the content:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">contentLength</span> <span class="o">=</span> <span class="nx">content</span>
  <span class="p">.</span><span class="nx">getBlockMap</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">total</span><span class="p">,</span> <span class="nx">block</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">block</span><span class="p">.</span><span class="nx">getText</span><span class="p">().</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="hydration-and-rendering">Hydration and rendering</h3>

<p>The content is now filtered, and saved in the database. Now we want to render it on a page! This is where Draft.js shakes up the flow quite a bit: we most likely want to render the content as HTML, so we need to first convert it. We also need to <em>hydrate</em> the content – provide it with external data that it requires, eg. replacing a reference to an image’s id by the actual image’s <strong>src</strong> and <strong>alt</strong>. Note that this hydration step would be required even if the content was stored as HTML.</p>

<p>The Draft.js -&gt; HTML conversion may seem like extra overhead, but its impact will be minimal compared to data retrieval for the hydration. Additionally, it provides us with an opportunity to <strong>customise the front-end HTML our users will look at</strong>, for example:</p>

<ul>
  <li>Adding classes to list items, <code class="language-plaintext highlighter-rouge">ul</code> and <code class="language-plaintext highlighter-rouge">ol</code> tags so you can use your favourite CSS architecture or methodology.</li>
  <li>Automagically making all links pointing to third-party sites open in a separate tabs by adding <code class="language-plaintext highlighter-rouge">target="_blank"</code> on the <code class="language-plaintext highlighter-rouge">a</code> tags.</li>
</ul>

<p>In practice, the API allows completely arbitrary rendering. It comes from the <a href="https://github.com/springload/draftjs_exporter">Draft.js exporter</a>, and is heavily inspired by React’s <a href="https://facebook.github.io/react/docs/top-level-api.html#react.createelement"><code class="language-plaintext highlighter-rouge">createElement</code></a> (what powers JSX):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Basic example – let’s render all ul tags with an extra BEM class.
</span><span class="n">BLOCK_TYPES</span><span class="p">.</span><span class="n">UNORDERED_LIST_ITEM</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">'element'</span><span class="p">:</span> <span class="s">'li'</span><span class="p">,</span>
    <span class="s">'wrapper'</span><span class="p">:</span> <span class="s">'ul'</span><span class="p">,</span>
    <span class="s">'wrapper_props'</span><span class="p">:</span> <span class="p">{</span><span class="s">'class'</span><span class="p">:</span> <span class="s">'list--bullet'</span><span class="p">},</span>
<span class="p">},</span>

<span class="c1"># For ols, we want more control. Let’s add the nesting level as a class.
</span><span class="k">def</span> <span class="nf">ordered_list</span><span class="p">(</span><span class="n">props</span><span class="p">):</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s">'block'</span><span class="p">][</span><span class="s">'depth'</span><span class="p">]</span>

    <span class="c1"># This will create an ol tag like this:
</span>    <span class="c1"># &lt;ol class="list--numbered list--depth-1"&gt;&lt;/ol&gt;
</span>    <span class="k">return</span> <span class="n">DOM</span><span class="p">.</span><span class="n">create_element</span><span class="p">(</span><span class="s">'ol'</span><span class="p">,</span> <span class="p">{</span>
        <span class="s">'class'</span><span class="p">:</span> <span class="s">'list--numbered list--depth-{0}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span>
    <span class="p">},</span> <span class="n">props</span><span class="p">[</span><span class="s">'children'</span><span class="p">])</span>

<span class="c1"># Finally, we said we want our links to open in a separate tab when they point at external sites. Easy!
</span><span class="k">def</span> <span class="nf">link</span><span class="p">(</span><span class="n">props</span><span class="p">):</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'href'</span><span class="p">:</span> <span class="n">props</span><span class="p">[</span><span class="s">'url'</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="c1"># If the URL does not start with /, add a target attribute.
</span>    <span class="k">if</span> <span class="n">props</span><span class="p">[</span><span class="s">'url'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">'/'</span><span class="p">:</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s">'target'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'_blank'</span>

    <span class="k">return</span> <span class="n">DOM</span><span class="p">.</span><span class="n">create_element</span><span class="p">(</span><span class="s">'a'</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">props</span><span class="p">[</span><span class="s">'children'</span><span class="p">])</span>
</code></pre></div></div>

<p>Isn’t that exciting?! Unfortunately (insert sad face emoji here), this isn’t fully hooked up in Wagtail just yet. For content storage and rendering, Wagtail still uses its own <a href="https://github.com/thibaudcolas/draftjs_exporter_wagtaildbhtml">HTML-like / XML representation</a>. There is an open <a href="https://github.com/wagtail/wagtail/issues/4223">feature request</a> to develop this further – feel free to chime in with your thoughts.</p>

<blockquote>
  <p>Have a look at the <a href="https://github.com/springload/draftjs_exporter">Draft.js exporter</a> that powers our editor to learn more about the rendering API.</p>
</blockquote>

<h2 id="beyond-rich-text">Beyond rich text</h2>

<p>With the help of Draft.js, we are bringing more <a href="https://torchbox.com/blog/rich-text-fields-and-faster-horses/">structure and semantics</a> to rich text, and making rich text more reliable for end users. This doesn’t mean that developers should start using rich text for all content. Wagtail’s StreamField still is a wonderful medium. Plain text also has a bright future.</p>

<p>However, beyond the rich text pipeline, there is another area where Draft.js helps a lot: building better user experiences for content authors. This could be as simple as having a reliable way to measure the length of written content, or calculating other useful metrics like <a href="https://github.com/vixdigital/wagtail-readinglevel">reading level</a>. Or simply converting “quotes” into their “smart” equivalent, to make your site’s microcopy shine even brighter. All of those features could (and should) be available on plain-text content, and here as well Draft.js and its programmatic API could help tremendously.</p>

<p><a href="https://www.draftail.org/">Draftail</a> already does quite a bit in this direction, in particular with its keyboard-centric control, and we’ll explore future possibilities in an upcoming blog post.</p>
</div>



  <footer>
    <p class="meta">
      
<span class="byline author vcard">By <span class="fn">Thibaud Colas</span></span>

      









<time datetime="2018-03-13T18:03:21+00:00" pubdate data-updated="true">2018-03-13 18:03</time>
      

<span class="categories">
  
    
      <a class="category" href="/categories/wagtail/">Wagtail</a>,
    
      <a class="category" href="/categories/javascript/">JavaScript</a>,
    
      <a class="category" href="/categories/react/">React</a>,
    
      <a class="category" href="/categories/draftjs/">Draftjs</a>,
    
      <a class="category" href="/categories/draftail/">Draftail</a>
    
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/why-wagtail-new-editor-is-built-with-draft-js" title="Previous Post: Why Wagtail’s new editor is built with Draft.js">&laquo; Why Wagtail’s new editor is built with Draft.js</a>
      
      
        <a class="basic-alignment right" href="/introducing-draft-js-in-wagtail" title="Next Post: Introducing Draft.js in Wagtail">Introducing Draft.js in Wagtail &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/google-season-of-docs-creating-wagtail-developer-onboarding-tutorials">Google Season of Docs: Creating Wagtail Developer Onboarding Tutorials</a>
      </li>
    
      <li class="post">
        <a href="/evaluating-carbon-footprint-django-wagtail">Evaluating the carbon footprint of Django and Wagtail - Django London</a>
      </li>
    
      <li class="post">
        <a href="/wagtails-new-developer-relations-team">Wagtail’s new Developer Relations team</a>
      </li>
    
      <li class="post">
        <a href="/wagtail-cms-projects-for-google-summer-of-code-2023">Wagtail CMS projects for Google Summer of Code 2023</a>
      </li>
    
      <li class="post">
        <a href="/2023-web-conferences">2023 web conferences</a>
      </li>
    
  </ul>
</section>

  
<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos" data-user="thibaudcolas" data-count="5">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/thibaudcolas">@thibaudcolas</a> on GitHub
  
  <script src="/javascripts/github.js"></script>
</section>


</aside>


    </div>
  </div>
  <footer><p>
  By <a href="" rel="author">Thibaud Colas</a> -
  Content available under <a class="license" rel="license" href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a> -
  <span class="credit">Hosted on <a href="https://pages.github.com/">GitHub Pages</a></span> -
  <a class="fork-link" href="https://github.com/thibaudcolas/thibaudcolas">View source</a>
</p>

</footer>
  

<script src="/javascripts/libs/instantclick.min.js" data-no-instant></script>
<script data-no-instant>InstantClick.init(50);</script>


</body>
</html>
